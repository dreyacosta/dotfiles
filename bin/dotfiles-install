#!/bin/bash

readonly BACKUP_DIR="$HOME/dotfiles-bak"

platform="$1"
shift

dotfiles-log "Starting dotfiles installation for $platform"
dotfiles-log "Backup directory: $BACKUP_DIR"

has_errors=false

while [[ $# -gt 0 ]]; do
  case "$1" in
  --dotfiles)
    shift
    dotfile_args=()
    while [[ $# -gt 0 && ! "$1" =~ ^-- ]]; do
      dotfile_args+=("$1")
      shift
    done
    dotfiles-install-files "${dotfile_args[@]}" || has_errors=true
    continue
    ;;
  --config-dirs)
    shift
    config_args=()
    while [[ $# -gt 0 && ! "$1" =~ ^-- ]]; do
      config_args+=("$1")
      shift
    done
    dotfiles-install-config "${config_args[@]}" || has_errors=true
    continue
    ;;
  --etc-dirs)
    shift
    etc_args=()
    while [[ $# -gt 0 && ! "$1" =~ ^-- ]]; do
      etc_args+=("$1")
      shift
    done
    dotfiles-install-etc "${etc_args[@]}" || has_errors=true
    continue
    ;;
  *)
    dotfiles-log "Unknown argument: $1"
    has_errors=true
    ;;
  esac
  shift
done

if [[ "$has_errors" == false ]]; then
  dotfiles-log "✓ All dotfiles installed successfully!"
else
  dotfiles-log "✗ Installation completed with errors"
  exit 1
fi
