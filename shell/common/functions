# Create a new directory and enter it
function md() {
  mkdir -p "$@" && cd "$@"
}

function dockersoftcleanup() {
  echo "Delete all 'untagged/dangling' (<none>) images"
  docker rmi $(docker images -q -f dangling=true)
}

function dockercleanup() {
  echo "Kill all running containers"
  docker kill $(docker ps -q)

  echo "Delete all stopped containers (including data-only containers)"
  docker rm $(docker ps -a -q)

  echo "Delete all 'untagged/dangling' (<none>) images"
  docker rmi $(docker images -q -f dangling=true)
}

function dockercleanupvolumes() {
  docker volume rm $(docker volume ls -qf dangling=true)
}

function dockercleanupimages() {
  echo "Delete all images"
  docker rmi -f $(docker images -q)
}

# Create a new worktree and branch from within current git directory.
ga() {
  if [[ -z "$1" ]]; then
    echo "Usage: ga [branch name]"
    exit 1
  fi

  local branch_name="$1"
  local base_name="$(basename "$PWD")"
  local worktree_path="../${base_name}--${branch_name}"
  local session_name="${base_name}--${branch_name}"

  git worktree add -b "$branch_name" "$worktree_path"
  mise trust "$worktree_path "

  if tmux has-session -t "$session_name" 2>/dev/null; then
    if [[ -n "${TMUX:-}" ]]; then
      tmux switch-client -t "$session_name"
    else
      tmux attach -t "$session_name"
    fi
    return
  fi

  if [[ -n "${TMUX:-}" ]]; then
    tmux new-session -ds "$session_name" -c "$worktree_path"
    tmux switch-client -t "$session_name"
  else
    tmux new-session -s "$session_name" -c "$worktree_path"
  fi
}

# Remove worktree and branch from within active worktree directory.
gd() {
  if gum confirm "Remove worktree and branch?"; then
    local cwd_path branch_name root_name session_name root_session root_path attach_root

    cwd_path="$(pwd)"
    worktree="$(basename "$cwd_path")"

    # split on first `--`
    root_name="${worktree%%--*}"
    branch_name="${worktree#*--}"
    session_name="${root_name}--${branch_name}"
    root_session="$root_name"
    root_path="../$root_name"
    attach_root=false

    # Protect against accidentially nuking a non-worktree directory
    if [[ "$root_name" != "$worktree" ]]; then
      cd "$root_path"

      if tmux has-session -t "$root_session" 2>/dev/null; then
        if [[ -n "${TMUX:-}" ]]; then
          tmux switch-client -t "$root_session"
        else
          attach_root=true
        fi
      else
        if [[ -n "${TMUX:-}" ]]; then
          tmux new-session -ds "$root_session" -c "$root_path"
          tmux switch-client -t "$root_session"
        else
          tmux new-session -ds "$root_session" -c "$root_path"
          attach_root=true
        fi
      fi

      git worktree remove "$worktree" --force
      git branch -D "$branch_name"

      if tmux has-session -t "$session_name" 2>/dev/null; then
        tmux kill-session -t "$session_name"
      fi

      if [[ "$attach_root" == true ]]; then
        tmux attach -t "$root_session"
      fi
    fi
  fi
}
